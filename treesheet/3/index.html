<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  
  <!--meta viewport: https://www.npmjs.com/package/@hint/hint-meta-viewport-->
  <!--meta name="viewport" content="width=device-width, initial-scale=1.0"-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#182034">
  <link rel="icon" type="image/png" sizes="48x48" href="./images/favicon-48x48.png">
  
  <title>Test Note App</title>
  <!--link rel="stylesheet" href="css/styles.css"-->
  
  <!-- This lets it make as Android app (In Chrome browser menut, Add to Homepage, search on main screen new icon with this app) -->
  <!--meta name="mobile-web-app-capable" content="yes" -->
  <!-- better alternative is: Progressive Web App
    https://addyosmani.com/blog/getting-started-with-progressive-web-apps/
    https://developers.google.com/web/progressive-web-apps/
    examples: https://github.com/hemanth/awesome-pwa?tab=readme-ov-file
    calculator: https://calculator-app-tau.vercel.app/ https://github.com/soransh-singh/calculatorApp-FrontendMentor/blob/main/index.html
  -->

  <!-- PWA -->
  <link rel="manifest" href="app.webmanifest">

  
  <!--
    body {
      //margin: 0;
      //padding: 0;
      //overflow: hidden;
      height: 100%;
      width: 100%;
    }
  -->
  <style>
    body {
      height: 100%;
      width: 100%;
    }
    canvas {
      display: block;
      position: absolute;
      top: 0; bottom: 0;
      left: 0; right: 0;
      width: 100%;
      height: 100%;
    }
    dddcanvas {
      display: block;
      width: 100vw;
      height: 100vh;
    }
    .editable-box {
      position: absolute;
      border: 1px solid #888;
      padding: 4px;
      font-size: 16px;
      background: #fafafa;
      min-width: 100px;
      min-height: 24px;
      resize: none;
    }
  </style>
</head>
<body>
  <canvas id="fullscreenCanvas"></canvas>
  <textarea id="editableBox" class="editable-box" style="display:none;"></textarea>
  <script>
    var possibleContexts = ['bitmaprenderer', '2d', 'webgl', 'webgl2', 'experimental-webgl', 'experimental-webgl2', 'dummy'];
    var availableContexts = possibleContexts.filter(function(c) {
      var canvas = document.createElement('canvas');
      if (canvas.getContext(c)) { return c; }
    });
  
    //alert('available contexts: ' + availableContexts);
  
    const canvas = document.getElementById('fullscreenCanvas');
    const ctx = canvas.getContext('2d');
    const editableBox = document.getElementById('editableBox');
    
    const circles = [
      {x:70,y:100,r:30,c:'green'},
      {x:140,y:100,r:30,c:'red'},
      {x:210,y:100,r:30,c:'yellow'},
      {x:280,y:100,r:30,c:'pink'}
    ];
    
    var textLabel1 = "<empty>";
    
    // Example drawing
    function draw() {


      ctx.save();
      ctx.fillStyle = 'skyblue';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // line
      ctx.strokeStyle = "grey";//"#0077cc";
      ctx.lineWidth = 0.5;
      //ctx.beginPath();
      //ctx.moveTo(100, 100);
      //ctx.lineTo(400, 200);
      //ctx.closePath();
      //ctx.stroke();
      ctx.strokeRect(5, 5, canvas.width - 10, canvas.height - 10);
      ctx.restore();

      // text
      ctx.save();
      ctx.font = '10px sans-serif';
      ctx.fillStyle = '#000';
      ctx.fillText("v0.6", 8, 18);
      ctx.restore();
      
      // circles
      ctx.save();
      for (var i = 0; i < circles.length; i++) {
        const c = circles[i];
        ctx.fillStyle = c.c;
        ctx.beginPath();
        ctx.arc(c.x, c.y, c.r, 0, 2 * Math.PI);
        ctx.closePath();
        ctx.fill();
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 1;
        ctx.stroke();
      }
      ctx.restore();

      ctx.save();
      ctx.font = '16px sans-serif';
      ctx.fillStyle = '#000';
      ctx.fillText(textLabel1, 70, canvas.height - 30);
      ctx.restore();
    }

    function resizeCanvas() {
      //alert('aserser');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight+50;

      draw();
    }
    
    function showEditableBox() {
      //const editableBox = document.getElementById('editableBox');
      editableBox.style.display = 'block';
      editableBox.style.left = '20px';
      editableBox.style.top = '200px';
      editableBox.style.width = '200px';
      editableBox.style.height = '30px';
      editableBox.value = "Simple text here";
    }
    
    function hideEditableBox() {
      //const editableBox = document.getElementById('editableBox');
      editableBox.style.display = 'none';
    }
    
    async function onCanvasMouseDown(e) {
      const rect = canvas.getBoundingClientRect();
      const mx = e.clientX - rect.left;
      const my = e.clientY - rect.top;
      //alert('x: ' + mx + ', y: ' + my);
      {
        for (var i = 0; i < circles.length; i++) {
          const c = circles[i];
          const dx = mx - c.x;
          const dy = my - c.y;
          if (dx*dx + dy*dy <= c.r*c.r) {
            // handler for circle #i
            if (i === 0) {
              // clicked on green circle
              showEditableBox();
            } else if (i === 1) {
              // clicked on red circle
              hideEditableBox();
            } else if (i === 2) {
              // https://developer.mozilla.org/en-US/docs/Web/API/Clipboard
              const data = new Blob(["TT[778]MM[77]|This is app specific version" + Math.random()], { type: 'text/html' });
              const item = new ClipboardItem({'text/html': data, 'text/plain': 'jkhlasdjkfhsdlfsdfh' + Math.random()});
              /*const clipboardItemData = {
                ["ttt/mywebnotesapp"]: "TT[778]MM[77]|This is app specific version",
                [type]: "This is simple text version"
              };*/
              await navigator.clipboard.write([item]);
              /*navigator.clipboard.writeText("Dummy text to copy to cpbrd").then(() => {
              }).catch(err => {
                alert("failed to copy: " + err);
              });*/
            } else if (i === 3) {
              const clipboardContents = await navigator.clipboard.read(['text/html']); // to prevent sanitization
              for (const item of clipboardContents) {
                for (const mimeType of item.types) {
                  if (mimeType === 'text/html') {
                    const blob = item.getType('text/html');
                    blob.then((b) => {
                      for (let key in b) {
                        console.log(`${key}: ${b[key]}`);
                      }
                      //console.log(b.arrayBuffer());
                      b.text().then((t) => { textLabel1 = t; draw(); } );
                    });
                    /*showEditableBox();
                    const editableBox = document.getElementById('editableBox');
                    editableBox.value = blob;*/
                  }
                }
              }
            }
          }
        }
      }
    }
    
    function onCanvasTouchStart(e) {
      const touch = e.touches[0];
      onCanvasMouseDown(touch);
    }
    
    function onEditableBoxInput() {
      editableBox.style.height = 'auto';
      editableBox.style.height = Math.min(editableBox.scrollHeight, 60) + 'px';
    }
    
    
    window.addEventListener("load", ()=>{
      canvas.addEventListener('mousedown', onCanvasMouseDown);
      canvas.addEventListener('touchstart', onCanvasTouchStart);

      editableBox.addEventListener('input', onEditableBoxInput);

      window.addEventListener('resize', resizeCanvas);
      resizeCanvas();
      
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("js/service-worker.js")
          .then((registration) => console.log("Service worker registered"))
          .catch((error) => console.log("Service worker registration failed!", error));
      }
    });
    
  </script>
  <!--script type="text/javascript" src="js/main.js"></script-->
  <script type="text/javascript" src="js/render.js"></script>
</body>
</html>